name: Secret Scanning

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  secret-scan:
    name: Scan for Exposed Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for .env files
        run: |
          echo "Checking for .env files in repository..."
          if find . -name ".env*" -not -path "*/node_modules/*" -not -path "*/.git/*" | grep -q .; then
            echo "::error::Found .env files in repository!"
            find . -name ".env*" -not -path "*/node_modules/*" -not -path "*/.git/*"
            exit 1
          else
            echo "No .env files found - Good!"
          fi

      - name: Check for MCP configuration files
        run: |
          echo "üîç Checking for exposed MCP configuration files..."

          # Check for MCP config files
          if find . -name "mcp.json" -o -name ".mcp.json" -o -name "mcp_server_config.json" \
            -o -name "claude_desktop_config.json" -o -name "claude.json" \
            | grep -v node_modules | grep -v .git | grep -q .; then
            echo "::error::Found MCP configuration files in repository!"
            find . -name "mcp.json" -o -name ".mcp.json" -o -name "mcp_server_config.json" \
              -o -name "claude_desktop_config.json" -o -name "claude.json" | grep -v node_modules | grep -v .git
            exit 1
          fi

          # Check for backup files that might contain tokens
          echo "Checking for backup files with potential secrets..."
          if find . \( -name "*.bak" -o -name "*.old" -o -name "*.tmp" -o -name "*_backup.*" \) \
            -not -path "*/node_modules/*" -not -path "*/.git/*" | grep -q .; then
            echo "::warning::Found backup files - check if they contain secrets"
            find . \( -name "*.bak" -o -name "*.old" -o -name "*.tmp" -o -name "*_backup.*" \) \
              -not -path "*/node_modules/*" -not -path "*/.git/*"
          fi

          echo "MCP configuration check complete"

      - name: Check for common secret patterns
        run: |
          echo "Scanning for common secret patterns..."

          # API Keys
          if grep -r -E "(api[_-]?key|apikey)\s*[=:]\s*['\"][^'\"]{20,}['\"]" . \
            --include="*.js" --include="*.ts" --include="*.py" --include="*.json" \
            --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null; then
            echo "::warning::Found potential API keys in code"
          fi

          # Hardcoded passwords
          if grep -r -E "password\s*[=:]\s*['\"][^'\"]{8,}['\"]" . \
            --include="*.js" --include="*.ts" --include="*.py" --include="*.json" \
            --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null; then
            echo "::warning::Found potential hardcoded passwords"
          fi

          # AWS Access Keys
          if grep -r -E "AKIA[0-9A-Z]{16}" . \
            --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null; then
            echo "::error::Found AWS Access Key ID!"
            exit 1
          fi

          # GitHub Personal Access Tokens (all types)
          if grep -r -E "gh[pousr]_[a-zA-Z0-9]{36,}" . \
            --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null; then
            echo "::error::Found GitHub Token (ghp_, gho_, ghs_, ghu_, or ghr_)!"
            exit 1
          fi

          # Anthropic API Keys
          if grep -r -E "sk-ant-api[0-9]{2}-[a-zA-Z0-9-_]{95}" . \
            --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null; then
            echo "::error::Found Anthropic API Key!"
            exit 1
          fi

          # OpenAI API Keys
          if grep -r -E "sk-[a-zA-Z0-9]{48}" . \
            --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null; then
            echo "::error::Found OpenAI API Key!"
            exit 1
          fi

          # Generic Bearer tokens
          if grep -r -E "Bearer [a-zA-Z0-9_\-\.=]{30,}" . \
            --include="*.js" --include="*.ts" --include="*.py" --include="*.json" \
            --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null; then
            echo "::warning::Found Bearer token in code"
          fi

          echo "Pattern scan complete"

      - name: Verify .gitignore has security entries
        run: |
          echo "Checking .gitignore for security patterns..."

          MISSING_PATTERNS=()

          # Check for .env
          if ! grep -q "\.env" .gitignore 2>/dev/null; then
            MISSING_PATTERNS+=(".env")
            echo "::error::.gitignore does not contain .env pattern!"
          fi

          # Check for credentials
          if ! grep -q "credentials" .gitignore 2>/dev/null; then
            MISSING_PATTERNS+=("credentials")
            echo "::warning::.gitignore should include credentials.json pattern"
          fi

          # Check for MCP configs
          if ! grep -q -E "(mcp\.json|claude.*config)" .gitignore 2>/dev/null; then
            MISSING_PATTERNS+=("MCP configs")
            echo "::error::.gitignore should include MCP configuration files!"
          fi

          # Check for backup files
          if ! grep -q -E "(\*\.bak|\*\.old)" .gitignore 2>/dev/null; then
            MISSING_PATTERNS+=("backup files")
            echo "::warning::.gitignore should include backup file patterns (*.bak, *.old)"
          fi

          # Check for key files
          if ! grep -q "\.key" .gitignore 2>/dev/null; then
            MISSING_PATTERNS+=("*.key")
            echo "::warning::.gitignore should include *.key pattern"
          fi

          if [ ${#MISSING_PATTERNS[@]} -gt 0 ]; then
            echo ""
            echo "‚ö†Ô∏è  Missing patterns in .gitignore:"
            printf '%s\n' "${MISSING_PATTERNS[@]}"
            echo ""
            echo "Recommended .gitignore entries:"
            echo "--------------------------------"
            echo "# Environment and secrets"
            echo ".env"
            echo ".env.*"
            echo "*.env"
            echo ""
            echo "# MCP and Claude configurations"
            echo "mcp.json"
            echo ".mcp.json"
            echo "mcp_server_config.json"
            echo "claude_desktop_config.json"
            echo "claude.json"
            echo ""
            echo "# MCP system config locations (OS-specific)"
            echo "# Windows"
            echo "%APPDATA%/Claude/"
            echo "# macOS"
            echo "~/Library/Application Support/Claude/"
            echo "# Linux"
            echo "~/.config/claude/"
            echo ""
            echo "# Backup files"
            echo "*.bak"
            echo "*.old"
            echo "*.tmp"
            echo "*_backup.*"
            echo ""
            echo "# Credentials"
            echo "credentials.json"
            echo "secrets.json"
            echo "*.key"
            echo "*.pem"
            echo ""
            exit 1
          fi

          echo "‚úÖ .gitignore security check passed"

      - name: Security scan summary
        if: always()
        run: |
          echo "================================================"
          echo "           üîê Security Scan Summary"
          echo "================================================"
          echo ""
          echo "Scans performed:"
          echo "  ‚úì TruffleHog (verified secrets)"
          echo "  ‚úì Gitleaks (comprehensive scan)"
          echo "  ‚úì .env files check"
          echo "  ‚úì MCP configuration files check"
          echo "  ‚úì Backup files check"
          echo "  ‚úì AWS Keys scan"
          echo "  ‚úì GitHub Tokens scan (ghp_, gho_, ghs_, ghu_, ghr_)"
          echo "  ‚úì Anthropic API Keys scan"
          echo "  ‚úì OpenAI API Keys scan"
          echo "  ‚úì Bearer tokens scan"
          echo "  ‚úì .gitignore validation"
          echo ""
          echo "================================================"
